<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ski Race - V0.1</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
        #joystick {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 100px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            touch-action: none;
            display: none;
        }
        #knob {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 25px;
            left: 25px;
        }
        #stats {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 24px;
            text-shadow: 1px 1px 2px black;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border: 2px solid white;
            border-radius: 5px;
            display: none;
        }
        #bonus, #flagHit, #penalty, #correct, #finishMessage, #npcHit, #birdHit {
            position: absolute;
            color: yellow;
            font-size: 30px;
            font-family: Arial, sans-serif;
            text-shadow: 1px 1px 2px black;
            display: none;
        }
        #bonus, #flagHit, #penalty, #npcHit, #birdHit {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #correct {
            top: 50%;
            transform: translateY(-50%);
        }
        #correct.left {
            left: 20px;
        }
        #correct.right {
            right: 20px;
        }
        #finishMessage {
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
        }
        #flagHit {
            color: red;
        }
        #penalty {
            color: orange;
        }
        #correct {
            color: green;
        }
        .mini-score {
            position: absolute;
            color: yellow;
            font-size: 20px;
            font-family: Arial, sans-serif;
            text-shadow: 1px 1px 2px black;
            pointer-events: none;
            transition: opacity 1s, transform 1s;
        }
        .mini-score.penalty {
            color: orange;
        }
        .mini-score.fade {
            opacity: 0;
            transform: translateY(-50px);
        }
        #gameOver, #levelComplete {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            text-align: center;
            font-family: Arial, sans-serif;
            display: none;
        }
        #welcome {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            text-align: center;
            font-family: Arial, sans-serif;
            max-width: 500px;
        }
        #autoPlay {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-family: Arial, sans-serif;
            display: none;
        }
        #toggleCamera {
            position: absolute;
            bottom: 20px;
            left: 20px;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-family: Arial, sans-serif;
            display: none;
        }
        #fireSnowball {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateX(70px);
            padding: 10px;
            background: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            font-family: Arial, sans-serif;
            display: none;
        }
        #autoThrow {
            position: absolute;
            bottom: 20px;
            right: 100px;
            padding: 10px;
            background: #FF9800;
            color: white;
            border: none;
            cursor: pointer;
            font-family: Arial, sans-serif;
            display: none;
        }
        #toggleSnow {
            position: absolute;
            bottom: 20px;
            right: 180px;
            padding: 10px;
            background: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            font-family: Arial, sans-serif;
            display: none;
        }
        #miniMap {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            display: none;
        }
        #progressBar {
            position: absolute;
            bottom: 100px;
            left: 50px;
            width: 20px;
            height: 200px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid white;
            border-radius: 5px;
            display: none;
        }
        #progressFill {
            width: 100%;
            background: white;
            border-radius: 3px;
            transition: height 0.2s;
            position: absolute;
            bottom: 0;
        }
        button {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background: #45a049;
        }
        #fireSnowball:hover, #toggleSnow:hover {
            background: #1976D2;
        }
        #autoThrow:hover {
            background: #F57C00;
        }
    </style>
</head>
<body>
    <div id="joystick"><div id="knob"></div></div>
    <div id="stats"></div>
    <div id="bonus"></div>
    <div id="flagHit"></div>
    <div id="penalty"></div>
    <div id="correct"></div>
    <div id="npcHit"></div>
    <div id="birdHit"></div>
    <div id="finishMessage"></div>
    <div id="gameOver">
        <h1>Game Over</h1>
        <p id="finalStats"></p>
        <button onclick="restartGame()">Play Again</button>
    </div>
    <div id="levelComplete">
        <h1>Level Complete!</h1>
        <p id="levelStats"></p>
        <button onclick="nextLevel()">Next Level</button>
    </div>
    <div id="welcome">
        <h1>Downhill Ski Challenge</h1>
        <p>Ski down steep slopes, weaving through flags, avoiding skiers, and collecting items to score points. Avoid hitting flags to keep your lives!</p>
        <p><strong>Controls:</strong><br>
        - Joystick: Move left/right, pull up to slow down, push down to speed up.<br>
        - Auto-Play: Toggle for automatic skiing.<br>
        - Camera: Toggle between default, bird's-eye, full bird's-eye, fly-around views.<br>
        - Fire Snowball: Shoot snowballs at skiers/birds (collect blue spheres for ammo).<br>
        - Auto-Throw: Toggle automatic snowball firing (default on).<br>
        - Toggle Snow: Enable/disable falling snow.<br>
        - Objective: Reach the finish line, passing flags for points, collecting speed-ups (yellow), extra lives (green), and snowballs (blue).<br>
        - Lives: Start with 3, lose 1 per flag hit, game over at 0.<br>
        - Scoring: +100 for correct side, -50 for wrong side, +50 for NPC snowball hit, +25 for bird hit.</p>
        <button onclick="startGame()">Start Game</button>
    </div>
    <button id="autoPlay" onclick="toggleAutoPlay()">Auto-Play: Off</button>
    <button id="toggleCamera" onclick="toggleCamera()">Camera: Default</button>
    <button id="fireSnowball" onclick="fireSnowball()">Fire Snowball</button>
    <button id="autoThrow" onclick="toggleAutoThrow()">Auto-Throw: On</button>
    <button id="toggleSnow" onclick="toggleSnow()">Snow: Off</button>
    <canvas id="miniMap"></canvas>
    <div id="progressBar"><div id="progressFill"></div></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script>
        let scene, camera, renderer, skier, flags = [], finishLine, terrain, trees = [], npcs = [], collectables = [], snowballs = [], birds = [], snowflakes = [], frontSnowflakes = [];
        let lives = 3, score = 0, time = 0, level = 1, gameOver = false, autoPlay = false, autoThrow = true, snowballAmmo = 0, snowActive = false;
        let clock = new THREE.Clock();
        let joystick = { x: 0, y: 0, active: false };
        let currentSpeed = 0, speedBoostTimer = 0, skidTimer = 0;
        let skierParts = {};
        let stumbleTimer = 0;
        let miniMap, miniMapCtx;
        let skiTrails = { left: [], right: [] };
        let mainTrails = { left: [], right: [] };
        let screenShake = { active: false, timer: 0, intensity: 0.5 };
        let lastFlagPassed = null;
        let cameraMode = 'default'; // default, birdsEye, fullBirdsEye, flyAround
        let flyAroundAngle = 0;
        let snowballCooldown = 0;

        function createSkier(isNPC = false, colorIndex = 0) {
            const skierGroup = new THREE.Group();
            const helmetGeometry = new THREE.SphereGeometry(0.32, 32, 32);
            const helmetMaterial = new THREE.MeshStandardMaterial({ color: 0x000000, roughness: 0.2 });
            const helmet = new THREE.Mesh(helmetGeometry, helmetMaterial);
            helmet.position.set(0, 2.2, 0);
            skierGroup.add(helmet);
            const gogglesGeometry = new THREE.BoxGeometry(0.5, 0.1, 0.1);
            const gogglesMaterial = new THREE.MeshStandardMaterial({ color: 0x333333, metalness: 0.8 });
            const goggles = new THREE.Mesh(gogglesGeometry, gogglesMaterial);
            goggles.position.set(0, 2.1, 0.3);
            skierGroup.add(goggles);
            const torsoGeometry = new THREE.CylinderGeometry(0.4, 0.4, 1, 32);
            const torsoColor = isNPC ? (colorIndex % 2 === 0 ? 0xFF0000 : 0x0000FF) : 0xFF3333;
            const torsoMaterial = new THREE.MeshStandardMaterial({ color: torsoColor, roughness: 0.5 });
            const torso = new THREE.Mesh(torsoGeometry, torsoMaterial);
            torso.position.set(0, 1.5, 0);
            skierGroup.add(torso);
            const armGeometry = new THREE.CylinderGeometry(0.12, 0.12, 0.9, 32);
            const armMaterial = new THREE.MeshStandardMaterial({ color: torsoColor, roughness: 0.5 });
            const leftArm = new THREE.Mesh(armGeometry, armMaterial);
            leftArm.position.set(-0.6, 1.5, 0);
            leftArm.rotation.z = Math.PI / 4;
            skierGroup.add(leftArm);
            const rightArm = new THREE.Mesh(armGeometry, armMaterial);
            rightArm.position.set(0.6, 1.5, 0);
            rightArm.rotation.z = -Math.PI / 4;
            skierGroup.add(rightArm);
            const poleGeometry = new THREE.CylinderGeometry(0.02, 0.02, 1.5, 16);
            const poleMaterial = new THREE.MeshStandardMaterial({ color: 0x666666, metalness: 0.5 });
            const leftPole = new THREE.Mesh(poleGeometry, poleMaterial);
            leftPole.position.set(-0.7, 1.0, 0);
            leftPole.rotation.z = Math.PI / 3;
            skierGroup.add(leftPole);
            const rightPole = new THREE.Mesh(poleGeometry, poleMaterial);
            rightPole.position.set(0.7, 1.0, 0);
            rightPole.rotation.z = -Math.PI / 3;
            skierGroup.add(rightPole);
            const legGeometry = new THREE.CylinderGeometry(0.2, 0.2, 1, 32);
            const legMaterial = new THREE.MeshStandardMaterial({ color: isNPC ? 0x333333 : 0x3333FF, roughness: 0.5 });
            const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
            leftLeg.position.set(-0.3, 0.5, 0);
            skierGroup.add(leftLeg);
            const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
            rightLeg.position.set(0.3, 0.5, 0);
            skierGroup.add(rightLeg);
            const skiGeometry = new THREE.BoxGeometry(0.2, 0.05, 2.2);
            const skiMaterial = new THREE.MeshStandardMaterial({ color: 0x999999, metalness: 0.3 });
            const leftSki = new THREE.Mesh(skiGeometry, skiMaterial);
            leftSki.position.set(-0.3, 0.025, 0);
            skierGroup.add(leftSki);
            const rightSki = new THREE.Mesh(skiGeometry, skiMaterial);
            rightSki.position.set(0.3, 0.025, 0);
            skierGroup.add(rightSki);
            if (!isNPC) {
                skierParts.helmet = helmet;
                skierParts.goggles = goggles;
                skierParts.torso = torso;
                skierParts.leftArm = leftArm;
                skierParts.rightArm = rightArm;
                skierParts.leftPole = leftPole;
                skierParts.rightPole = rightPole;
                skierParts.leftLeg = leftLeg;
                skierParts.rightLeg = rightLeg;
                skierParts.leftSki = leftSki;
                skierParts.rightSki = rightSki;
            }
            return skierGroup;
        }

        function generatePerlinNoise(width, depth, scale) {
            const noise = new Array(width * depth);
            for (let i = 0; i < width; i++) {
                for (let j = 0; j < depth; j++) {
                    const x = i / width * scale;
                    const y = j / depth * scale;
                    noise[i + j * width] = (Math.sin(x * 2) + Math.sin(y * 2)) * 0.5;
                }
            }
            return noise;
        }

        function createTerrain() {
            const width = 100, depth = 2000, segments = 50;
            const geometry = new THREE.PlaneGeometry(width, depth, segments, segments);
            const material = new THREE.MeshStandardMaterial({
                color: 0xF5F6F5,
                roughness: 0.9,
                metalness: 0.1,
                bumpScale: 0.1
            });
            const terrain = new THREE.Mesh(geometry, material);
            terrain.rotation.x = -Math.PI / 2;
            const noise = generatePerlinNoise(segments + 1, segments + 1, 5);
            const vertices = geometry.attributes.position.array;
            for (let i = 0; i <= segments; i++) {
                for (let j = 0; j <= segments; j++) {
                    const index = (i * (segments + 1) + j) * 3;
                    let z = noise[i + j * (segments + 1)] * 5 - (j / segments) * 40;
                    if (j > segments * 0.1 && j < segments * 0.125) z -= (j / segments - 0.1) * 100;
                    if (j > segments * 0.2 && j < segments * 0.225) z -= (j / segments - 0.2) * 100;
                    if (j > segments * 0.3 && j < segments * 0.325) z -= (j / segments - 0.3) * 100;
                    vertices[index + 2] = z;
                }
            }
            geometry.attributes.position.needsUpdate = true;
            geometry.computeVertexNormals();
            return terrain;
        }

        function createTree(x, z) {
            const treeGroup = new THREE.Group();
            const trunkGeometry = new THREE.CylinderGeometry(0.2, 0.2, 2, 16);
            const trunkMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
            trunk.position.set(0, 1, 0);
            treeGroup.add(trunk);
            const foliageGeometry = new THREE.ConeGeometry(1, 3, 16);
            const foliageMaterial = new THREE.MeshStandardMaterial({ color: 0x228B22 });
            const foliage = new THREE.Mesh(foliageGeometry, foliageMaterial);
            foliage.position.set(0, 2.5, 0);
            treeGroup.add(foliage);
            treeGroup.position.set(x, 0, z);
            return treeGroup;
        }

        function createNPC(x, z, colorIndex) {
            const npc = createSkier(true, colorIndex);
            npc.position.set(x, 0, z);
            npc.userData = { speed: 10 + Math.random() * 10, knockedOver: false, knockOverTimer: 0, spinAngle: 0 };
            return npc;
        }

        function createCollectable(type, x, z) {
            const geometry = new THREE.SphereGeometry(0.7, 32, 32);
            let color;
            if (type === 'speed') color = 0xFFFF00;
            else if (type === 'life') color = 0x00FF00;
            else color = 0x0000FF;
            const material = new THREE.MeshStandardMaterial({ color, emissive: color, emissiveIntensity: 1.0, roughness: 0.2 });
            const collectable = new THREE.Mesh(geometry, material);
            collectable.position.set(x, 1.5, z);
            collectable.userData = { type, baseScale: 0.7, pulseTime: Math.random() * Math.PI * 2 };
            return collectable;
        }

        function createSnowball(x, y, z, direction) {
            const geometry = new THREE.SphereGeometry(0.2, 16, 16);
            const material = new THREE.MeshStandardMaterial({ color: 0xFFFFFF });
            const snowball = new THREE.Mesh(geometry, material);
            snowball.position.set(x, y, z);
            snowball.userData = { direction, speed: 50 };
            return snowball;
        }

        function createBird(x, y, z) {
            const birdGroup = new THREE.Group();
            const bodyGeometry = new THREE.SphereGeometry(0.3, 16, 16);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0x666666 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            birdGroup.add(body);
            const wingGeometry = new THREE.BoxGeometry(0.5, 0.05, 0.3);
            const wingMaterial = new THREE.MeshStandardMaterial({ color: 0x555555 });
            const leftWing = new THREE.Mesh(wingGeometry, wingMaterial);
            leftWing.position.set(-0.4, 0, 0);
            birdGroup.add(leftWing);
            const rightWing = new THREE.Mesh(wingGeometry, wingMaterial);
            rightWing.position.set(0.4, 0, 0);
            birdGroup.add(rightWing);
            birdGroup.position.set(x, y, z);
            birdGroup.userData = { baseX: x, baseZ: z, hit: false, hitTimer: 0, spinAngle: 0 };
            return birdGroup;
        }

        function createSnowflake(x, y, z, isFront = false) {
            const geometry = new THREE.SphereGeometry(0.05, 8, 8);
            const material = new THREE.MeshStandardMaterial({ color: 0xFFFFFF, emissive: 0xFFFFFF, emissiveIntensity: 0.5 });
            const snowflake = new THREE.Mesh(geometry, material);
            snowflake.position.set(x, y, z);
            snowflake.userData = { speed: 2 + Math.random() * 2, isFront };
            return snowflake;
        }

        function createTrailParticle(x, z, time) {
            const geometry = new THREE.SphereGeometry(0.1, 8, 8);
            const material = new THREE.MeshStandardMaterial({ color: 0x808080, transparent: true, opacity: 0.8 });
            const particle = new THREE.Mesh(geometry, material);
            particle.position.set(x, terrain.geometry.attributes.position.array[Math.floor((z / -2000) * 50) * (50 + 1) * 3 + 2] + 0.05, z);
            particle.userData = { time: time };
            return particle;
        }

        function updateMainTrails() {
            mainTrails.left = mainTrails.left.filter(particle => {
                const age = time - particle.userData.time;
                if (age > 5) {
                    scene.remove(particle);
                    return false;
                }
                particle.material.opacity = 0.8 * (1 - age / 5);
                return true;
            });
            mainTrails.right = mainTrails.right.filter(particle => {
                const age = time - particle.userData.time;
                if (age > 5) {
                    scene.remove(particle);
                    return false;
                }
                particle.material.opacity = 0.8 * (1 - age / 5);
                return true;
            });
        }

        function initMiniMap() {
            miniMap = document.getElementById('miniMap');
            miniMapCtx = miniMap.getContext('2d');
            miniMap.width = 150;
            miniMap.height = 150;
        }

        function updateMiniMap() {
            if (!skier) return;
            miniMapCtx.clearRect(0, 0, miniMap.width, miniMap.height);
            const mapWidth = 100;
            const mapHeight = 2000;
            const scaleX = miniMap.width / mapWidth;
            const scaleY = miniMap.height / mapHeight;
            const centerX = miniMap.width / 2;
            const centerY = miniMap.height / 2;
            if (currentSpeed > 0) {
                skiTrails.left.push({ x: skier.position.x - 0.3, z: skier.position.z, time: time });
                skiTrails.right.push({ x: skier.position.x + 0.3, z: skier.position.z, time: time });
            }
            skiTrails.left = skiTrails.left.filter(point => time - point.time < 5);
            skiTrails.right = skiTrails.right.filter(point => time - point.time < 5);
            skiTrails.left.forEach(point => {
                const alpha = 1 - (time - point.time) / 5;
                miniMapCtx.fillStyle = `rgba(128, 128, 128, ${alpha})`;
                const x = centerX + (point.x - skier.position.x) * scaleX;
                const z = centerY + (point.z - skier.position.z) * scaleY;
                if (z > 0 && z < miniMap.height && x > 0 && x < miniMap.width) {
                    miniMapCtx.beginPath();
                    miniMapCtx.arc(x, z, 1.5, 0, Math.PI * 2);
                    miniMapCtx.fill();
                }
            });
            skiTrails.right.forEach(point => {
                const alpha = 1 - (time - point.time) / 5;
                miniMapCtx.fillStyle = `rgba(128, 128, 128, ${alpha})`;
                const x = centerX + (point.x - skier.position.x) * scaleX;
                const z = centerY + (point.z - skier.position.z) * scaleY;
                if (z > 0 && z < miniMap.height && x > 0 && x < miniMap.width) {
                    miniMapCtx.beginPath();
                    miniMapCtx.arc(x, z, 1.5, 0, Math.PI * 2);
                    miniMapCtx.fill();
                }
            });
            flags.forEach(flag => {
                miniMapCtx.fillStyle = flag.material.color.getStyle();
                const x = centerX + (flag.position.x - skier.position.x) * scaleX;
                const z = centerY + (flag.position.z - skier.position.z) * scaleY;
                if (z > 0 && z < miniMap.height && x > 0 && x < miniMap.width) {
                    miniMapCtx.beginPath();
                    miniMapCtx.arc(x, z, 3, 0, Math.PI * 2);
                    miniMapCtx.fill();
                }
            });
            trees.forEach(tree => {
                miniMapCtx.fillStyle = '#228B22';
                const x = centerX + (tree.position.x - skier.position.x) * scaleX;
                const z = centerY + (tree.position.z - skier.position.z) * scaleY;
                if (z > 0 && z < miniMap.height && x > 0 && x < miniMap.width) {
                    miniMapCtx.beginPath();
                    miniMapCtx.arc(x, z, 2, 0, Math.PI * 2);
                    miniMapCtx.fill();
                }
            });
            npcs.forEach(npc => {
                miniMapCtx.fillStyle = npc.children[2].material.color.getStyle();
                const x = centerX + (npc.position.x - skier.position.x) * scaleX;
                const z = centerY + (npc.position.z - skier.position.z) * scaleY;
                if (z > 0 && z < miniMap.height && x > 0 && x < miniMap.width) {
                    miniMapCtx.beginPath();
                    miniMapCtx.arc(x, z, 2, 0, Math.PI * 2);
                    miniMapCtx.fill();
                }
            });
            collectables.forEach(collectable => {
                miniMapCtx.fillStyle = collectable.material.color.getStyle();
                const x = centerX + (collectable.position.x - skier.position.x) * scaleX;
                const z = centerY + (collectable.position.z - skier.position.z) * scaleY;
                if (z > 0 && z < miniMap.height && x > 0 && x < miniMap.width) {
                    miniMapCtx.beginPath();
                    miniMapCtx.arc(x, z, 2, 0, Math.PI * 2);
                    miniMapCtx.fill();
                }
            });
            miniMapCtx.fillStyle = 'green';
            const finishX = centerX + (0 - skier.position.x) * scaleX;
            const finishZ = centerY + (-1850 - skier.position.z) * scaleY;
            if (finishZ > 0 && finishZ < miniMap.height) {
                miniMapCtx.fillRect(finishX - 15 * scaleX, finishZ - 1, 30 * scaleX, 2);
            }
            miniMapCtx.fillStyle = 'yellow';
            miniMapCtx.beginPath();
            miniMapCtx.arc(centerX, centerY, 4, 0, Math.PI * 2);
            miniMapCtx.fill();
        }

        function showMiniScore(text, x, z, isPenalty) {
            const div = document.createElement('div');
            div.className = 'mini-score' + (isPenalty ? ' penalty' : '');
            div.textContent = text;
            document.body.appendChild(div);
            const updatePosition = () => {
                const vector = new THREE.Vector3(x, 2, z);
                vector.project(camera);
                const canvasWidth = window.innerWidth;
                const canvasHeight = window.innerHeight;
                const posX = (vector.x * 0.5 + 0.5) * canvasWidth;
                const posY = (-vector.y * 0.5 + 0.5) * canvasHeight;
                div.style.left = `${posX}px`;
                div.style.top = `${posY}px`;
            };
            updatePosition();
            setTimeout(() => {
                div.classList.add('fade');
                setTimeout(() => document.body.removeChild(div), 1000);
            }, 100);
        }

        function showCorrectMessage(isBlue) {
            const correctEl = document.getElementById('correct');
            correctEl.textContent = 'Correct!';
            correctEl.className = 'left';
            if (!isBlue) correctEl.classList.add('right');
            correctEl.style.display = 'block';
            setTimeout(() => correctEl.style.display = 'none', 1000);
        }

        function showFinishMessage(distance) {
            const finishEl = document.getElementById('finishMessage');
            finishEl.textContent = `Finish Line: ${distance.toFixed(0)}m`;
            finishEl.style.display = 'block';
        }

        function hideFinishMessage() {
            document.getElementById('finishMessage').style.display = 'none';
        }

        function showNPCHitMessage() {
            const npcHitEl = document.getElementById('npcHit');
            npcHitEl.textContent = 'NPC Hit! +50';
            npcHitEl.style.display = 'block';
            setTimeout(() => npcHitEl.style.display = 'none', 1000);
        }

        function showBirdHitMessage() {
            const birdHitEl = document.getElementById('birdHit');
            birdHitEl.textContent = 'Bird Hit! +25';
            birdHitEl.style.display = 'block';
            setTimeout(() => birdHitEl.style.display = 'none', 1000);
        }

        function updateProgressBar() {
            if (!skier) return;
            const totalDistance = 1850;
            const currentDistance = Math.max(0, -skier.position.z);
            const progress = (currentDistance / totalDistance) * 100;
            document.getElementById('progressFill').style.height = `${progress}%`;
        }

        function isNPCTargetable(npc) {
            if (npc.userData.knockedOver) return false;
            const dist = skier.position.distanceTo(npc.position);
            if (dist > 30 || npc.position.z > skier.position.z) return false;
            const direction = npc.position.clone().sub(skier.position).normalize();
            const raycaster = new THREE.Raycaster(skier.position, direction, 0, dist);
            const intersects = raycaster.intersectObjects([terrain, ...trees, ...flags, ...collectables, finishLine], true);
            if (intersects.length > 0 && intersects[0].distance < dist) return false;
            return true;
        }

        function isBirdTargetable(bird) {
            if (bird.userData.hit) return false;
            const dist = skier.position.distanceTo(bird.position);
            if (dist > 50 || bird.position.z > skier.position.z) return false;
            const direction = bird.position.clone().sub(skier.position).normalize();
            const raycaster = new THREE.Raycaster(skier.position, direction, 0, dist);
            const intersects = raycaster.intersectObjects([terrain, ...trees, ...flags, ...collectables, finishLine], true);
            if (intersects.length > 0 && intersects[0].distance < dist) return false;
            return true;
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 20, 150);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.set(0, 5, 10);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            const joystickEl = document.getElementById('joystick');
            joystickEl.addEventListener('pointerdown', startJoystick);
            joystickEl.addEventListener('pointermove', updateJoystick);
            joystickEl.addEventListener('pointerup', resetJoystick);
            joystickEl.addEventListener('pointercancel', resetJoystick);
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            initMiniMap();
            document.getElementById('welcome').style.display = 'block';
            animate();
        }

        function setupGame() {
            terrain = createTerrain();
            scene.add(terrain);
            skier = createSkier();
            skier.position.set(0, 0, 0);
            scene.add(skier);
            flags = [];
            for (let i = 0; i < 40; i++) {
                const flagGeometry = new THREE.CylinderGeometry(0.1, 0.1, 3, 32);
                const flagMaterial = new THREE.MeshStandardMaterial({ color: i % 2 === 0 ? 0x0000FF : 0xFF0000 });
                const flag = new THREE.Mesh(flagGeometry, flagMaterial);
                const x = (Math.random() - 0.5) * 20;
                const z = -50 - i * 40;
                flag.position.set(x, 1.5, z);
                flags.push(flag);
                scene.add(flag);
            }
            trees = [];
            for (let i = 0; i < 100; i++) {
                const x = (Math.random() - 0.5) * 80;
                const z = -Math.random() * 1900;
                if (Math.abs(x) > 15 && Math.abs(z + 1850) > 50) {
                    const tree = createTree(x, z);
                    trees.push(tree);
                    scene.add(tree);
                }
            }
            npcs = [];
            for (let i = 0; i < 40; i++) {
                const x = (Math.random() - 0.5) * 30;
                const z = -Math.random() * 1800;
                const npc = createNPC(x, z, i);
                npcs.push(npc);
                scene.add(npc);
            }
            collectables = [];
            for (let i = 0; i < 40; i++) {
                const x = (Math.random() - 0.5) * 20;
                const z = -50 - i * 50;
                const type = i < 10 ? 'speed' : i < 20 ? 'life' : 'snowball';
                const collectable = createCollectable(type, x, z);
                collectables.push(collectable);
                scene.add(collectable);
            }
            for (let i = 0; i < 10; i++) {
                const x = (Math.random() - 0.5) * 20;
                const z = -50 - i * 100;
                const collectable = createCollectable('snowball', x, z);
                collectables.push(collectable);
                scene.add(collectable);
            }
            birds = [];
            for (let i = 0; i < 30; i++) {
                const x = (Math.random() - 0.5) * 80;
                const y = 30 + Math.random() * 10;
                const z = -Math.random() * 1800;
                const bird = createBird(x, y, z);
                birds.push(bird);
                scene.add(bird);
            }
            const finishGeometry = new THREE.BoxGeometry(30, 0.2, 2);
            const finishMaterial = new THREE.MeshStandardMaterial({ color: 0x00FF00 });
            finishLine = new THREE.Mesh(finishGeometry, finishMaterial);
            finishLine.position.set(0, 0.1, -1850);
            scene.add(finishLine);
            const ambientLight = new THREE.AmbientLight(0x606060);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xFFFFFF, 0.7);
            directionalLight.position.set(10, 20, 10);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            skiTrails = { left: [], right: [] };
            mainTrails = { left: [], right: [] };
            lastFlagPassed = null;
            score = 0;
            snowballAmmo = 0;
            skidTimer = 0;
        }

        function startGame() {
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('stats').style.display = 'block';
            document.getElementById('joystick').style.display = 'block';
            document.getElementById('autoPlay').style.display = 'block';
            document.getElementById('toggleCamera').style.display = 'block';
            document.getElementById('fireSnowball').style.display = 'block';
            document.getElementById('autoThrow').style.display = 'block';
            document.getElementById('toggleSnow').style.display = 'block';
            document.getElementById('miniMap').style.display = 'block';
            document.getElementById('progressBar').style.display = 'block';
            setupGame();
        }

        function startJoystick(e) {
            if (!autoPlay) {
                joystick.active = true;
                updateJoystick(e);
            }
        }

        function updateJoystick(e) {
            if (!joystick.active || autoPlay) return;
            const rect = document.getElementById('joystick').getBoundingClientRect();
            const x = e.clientX - rect.left - 50;
            const y = e.clientY - rect.top - 50;
            const dist = Math.sqrt(x * x + y * y);
            const maxDist = 25;
            if (dist > maxDist) {
                const scale = maxDist / dist;
                joystick.x = x * scale;
                joystick.y = y * scale;
            } else {
                joystick.x = x;
                joystick.y = y;
            }
            document.getElementById('knob').style.transform = `translate(${joystick.x}px, ${joystick.y}px)`;
            joystick.x /= 25;
            joystick.y /= 25;
        }

        function resetJoystick() {
            if (!autoPlay) {
                joystick.active = false;
                joystick.x = 0;
                joystick.y = 0;
                document.getElementById('knob').style.transform = 'translate(0px, 0px)';
            }
        }

        function toggleAutoPlay() {
            autoPlay = !autoPlay;
            document.getElementById('autoPlay').textContent = `Auto-Play: ${autoPlay ? 'On' : 'Off'}`;
            if (!autoPlay) resetJoystick();
        }

        function toggleCamera() {
            if (cameraMode === 'default') {
                cameraMode = 'birdsEye';
                document.getElementById('toggleCamera').textContent = 'Camera: Bird\'s-Eye';
            } else if (cameraMode === 'birdsEye') {
                cameraMode = 'fullBirdsEye';
                document.getElementById('toggleCamera').textContent = 'Camera: Full Bird\'s-Eye';
            } else if (cameraMode === 'fullBirdsEye') {
                cameraMode = 'flyAround';
                document.getElementById('toggleCamera').textContent = 'Camera: Fly-Around';
            } else {
                cameraMode = 'default';
                document.getElementById('toggleCamera').textContent = 'Camera: Default';
            }
        }

        function toggleAutoThrow() {
            autoThrow = !autoThrow;
            document.getElementById('autoThrow').textContent = `Auto-Throw: ${autoThrow ? 'On' : 'Off'}`;
        }

        function toggleSnow() {
            snowActive = !snowActive;
            document.getElementById('toggleSnow').textContent = `Snow: ${snowActive ? 'On' : 'Off'}`;
            if (snowActive) {
                snowflakes = [];
                frontSnowflakes = [];
                for (let i = 0; i < 100; i++) {
                    const x = skier.position.x + (Math.random() - 0.5) * 20;
                    const y = 20;
                    const z = skier.position.z + (Math.random() - 0.5) * 20;
                    const snowflake = createSnowflake(x, y, z, false);
                    snowflakes.push(snowflake);
                    scene.add(snowflake);
                }
                for (let i = 0; i < 50; i++) {
                    const x = skier.position.x + (Math.random() - 0.5) * 20;
                    const y = 20;
                    const z = skier.position.z - 10 + (Math.random() - 0.5) * 10;
                    const snowflake = createSnowflake(x, y, z, true);
                    frontSnowflakes.push(snowflake);
                    scene.add(snowflake);
                }
            } else {
                snowflakes.forEach(snowflake => scene.remove(snowflake));
                frontSnowflakes.forEach(snowflake => scene.remove(snowflake));
                snowflakes = [];
                frontSnowflakes = [];
            }
        }

        function fireSnowball() {
            if (snowballAmmo <= 0 || !skier) return;
            snowballAmmo--;
            let direction = new THREE.Vector3(0, 0, -1);
            let target = null;
            let minDist = Infinity;
            npcs.forEach(npc => {
                if (isNPCTargetable(npc)) {
                    const dist = skier.position.distanceTo(npc.position);
                    if (dist < minDist) {
                        minDist = dist;
                        target = npc;
                    }
                }
            });
            birds.forEach(bird => {
                if (isBirdTargetable(bird)) {
                    const dist = skier.position.distanceTo(bird.position);
                    if (dist < minDist) {
                        minDist = dist;
                        target = bird;
                    }
                }
            });
            if (target) {
                direction = target.position.clone().sub(skier.position).normalize();
            }
            const snowball = createSnowball(skier.position.x, skier.position.y + 1, skier.position.z, direction);
            snowballs.push(snowball);
            scene.add(snowball);
        }

        function animateSkier(delta) {
            let tiltAngle = -joystick.x * Math.PI / 6;
            let fallAngle = 0;
            if (stumbleTimer > 0) {
                stumbleTimer -= delta;
                if (stumbleTimer > 0.5) {
                    fallAngle = Math.min((1 - stumbleTimer) * Math.PI / 2, Math.PI / 3);
                    tiltAngle += Math.sin(stumbleTimer * 15) * Math.PI / 6;
                } else {
                    fallAngle = (stumbleTimer / 0.5) * Math.PI / 3;
                    tiltAngle += Math.sin(stumbleTimer * 10) * Math.PI / 8;
                }
                if (stumbleTimer <= 0) {
                    stumbleTimer = 0;
                }
            }
            if (skidTimer > 0) {
                skidTimer -= delta;
                const progress = skidTimer / 2;
                skier.rotation.y = Math.PI / 2 * (1 - progress);
                currentSpeed = currentSpeed * progress;
                skier.position.z -= currentSpeed * delta;
                if (skier.position.z < -1860) skier.position.z = -1860;
                if (time % 0.03 < delta) {
                    const leftParticle = createTrailParticle(skier.position.x - 0.3, skier.position.z, time);
                    const rightParticle = createTrailParticle(skier.position.x + 0.3, skier.position.z, time);
                    mainTrails.left.push(leftParticle);
                    mainTrails.right.push(rightParticle);
                    scene.add(leftParticle, rightParticle);
                }
                if (skidTimer <= 0) {
                    skidTimer = 0;
                    completeLevel();
                }
            }
            const leanFactor = Math.abs(joystick.x) * 0.3;
            const leanAngle = -joystick.x * Math.PI / 6;
            skierParts.torso.rotation.z = tiltAngle + leanAngle;
            skierParts.torso.rotation.x = fallAngle;
            skierParts.helmet.rotation.z = tiltAngle + leanAngle;
            skierParts.helmet.rotation.x = fallAngle;
            skierParts.goggles.rotation.z = tiltAngle + leanAngle;
            skierParts.goggles.rotation.x = fallAngle;
            skierParts.leftArm.rotation.z = Math.PI / 4 + (joystick.x > 0 ? leanFactor : -leanFactor);
            skierParts.rightArm.rotation.z = -Math.PI / 4 + (joystick.x > 0 ? -leanFactor : leanFactor);
            skierParts.leftPole.rotation.z = Math.PI / 3 + (joystick.x > 0 ? leanFactor : -leanFactor);
            skierParts.rightPole.rotation.z = -Math.PI / 3 + (joystick.x > 0 ? -leanFactor : leanFactor);
            const crouchFactor = Math.min(currentSpeed / 40, 1);
            const scaleY = 1 - crouchFactor * 0.2;
            skierParts.torso.position.y = 1.5 * scaleY;
            skierParts.torso.scale.y = scaleY;
            skierParts.helmet.position.y = (2.2 * scaleY) - (crouchFactor * 0.3);
            skierParts.goggles.position.y = (2.1 * scaleY) - (crouchFactor * 0.3);
            skierParts.leftArm.position.y = 1.5 * scaleY;
            skierParts.rightArm.position.y = 1.5 * scaleY;
            skierParts.leftPole.position.y = 1.0 * scaleY;
            skierParts.rightPole.position.y = 1.0 * scaleY;
            skierParts.leftLeg.position.y = 0.5 * scaleY;
            skierParts.rightLeg.position.y = 0.5 * scaleY;
            skierParts.leftSki.position.y = 0.025;
            skierParts.rightSki.position.y = 0.025;
            const skiAngle = -joystick.x * Math.PI / 6;
            skierParts.leftSki.rotation.y = skiAngle;
            skierParts.rightSki.rotation.y = skiAngle;
        }

        function knockOverFlag(flag) {
            flag.rotation.x = Math.PI / 2;
            flag.position.y = 0.1;
        }

        function knockOverNPC(npc) {
            npc.rotation.x = Math.PI / 2;
            npc.position.y -= 1.4;
            npc.userData.knockedOver = true;
            npc.userData.knockOverTimer = 3;
            npc.userData.spinAngle = 0;
            score += 50;
            showNPCHitMessage();
            showMiniScore('+50', npc.position.x, npc.position.z, false);
        }

        function hitBird(bird) {
            bird.userData.hit = true;
            bird.userData.hitTimer = 1;
            bird.userData.spinAngle = 0;
            score += 25;
            showBirdHitMessage();
            showMiniScore('+25', bird.position.x, bird.position.z, false);
        }

        function showFlagHit() {
            const flagHitEl = document.getElementById('flagHit');
            flagHitEl.textContent = 'Flag Hit!';
            flagHitEl.style.display = 'block';
            setTimeout(() => flagHitEl.style.display = 'none', 1000);
            screenShake.active = true;
            screenShake.timer = 0.5;
        }

        function showNPCHit() {
            screenShake.active = true;
            screenShake.timer = 0.5;
        }

        function showPenalty() {
            const penaltyEl = document.getElementById('penalty');
            penaltyEl.textContent = '-50';
            penaltyEl.style.display = 'block';
            setTimeout(() => penaltyEl.style.display = 'none', 1000);
        }

        function updateScreenShake(delta) {
            if (screenShake.active) {
                screenShake.timer -= delta;
                if (screenShake.timer <= 0) {
                    screenShake.active = false;
                    if (cameraMode === 'default' && skidTimer <= 0) {
                        const isSteep = skier.position.z > -250 && skier.position.z < -200 ||
                                        skier.position.z > -450 && skier.position.z < -400 ||
                                        skier.position.z > -650 && skier.position.z < -600;
                        if (isSteep) {
                            camera.position.set(skier.position.x, skier.position.y + 10, skier.position.z + 10);
                            camera.lookAt(skier.position.x, skier.position.y, skier.position.z - 5);
                        } else {
                            camera.position.set(skier.position.x, skier.position.y + 5, skier.position.z + 10);
                            camera.lookAt(skier.position);
                        }
                    }
                } else {
                    const shakeX = (Math.random() - 0.5) * screenShake.intensity;
                    const shakeY = (Math.random() - 0.5) * screenShake.intensity;
                    camera.position.set(skier.position.x + shakeX, skier.position.y + 5 + shakeY, skier.position.z + 10);
                }
            }
        }

        function updateCamera(delta) {
            if (!skier) return;
            if (skidTimer > 0) {
                flyAroundAngle += delta * 0.5;
                const radius = 15;
                camera.position.set(
                    skier.position.x + Math.sin(flyAroundAngle) * radius,
                    skier.position.y + 5,
                    skier.position.z + Math.cos(flyAroundAngle) * radius
                );
                camera.lookAt(skier.position);
            } else if (cameraMode === 'default' && !screenShake.active) {
                const isSteep = skier.position.z > -250 && skier.position.z < -200 ||
                                skier.position.z > -450 && skier.position.z < -400 ||
                                skier.position.z > -650 && skier.position.z < -600;
                if (isSteep) {
                    camera.position.set(skier.position.x, skier.position.y + 10, skier.position.z + 10);
                    camera.lookAt(skier.position.x, skier.position.y, skier.position.z - 5);
                } else {
                    camera.position.set(skier.position.x, skier.position.y + 5, skier.position.z + 10);
                    camera.lookAt(skier.position);
                }
            } else if (cameraMode === 'birdsEye') {
                camera.position.set(skier.position.x, skier.position.y + 20, skier.position.z);
                camera.lookAt(skier.position);
            } else if (cameraMode === 'fullBirdsEye') {
                camera.position.set(0, 200, -925);
                camera.lookAt(new THREE.Vector3(0, 0, -925));
            } else if (cameraMode === 'flyAround') {
                flyAroundAngle += delta * 0.5;
                const radius = 15;
                camera.position.set(
                    skier.position.x + Math.sin(flyAroundAngle) * radius,
                    skier.position.y + 5,
                    skier.position.z + Math.cos(flyAroundAngle) * radius
                );
                camera.lookAt(skier.position);
            }
        }

        function updateNPCs(delta) {
            npcs.forEach(npc => {
                if (npc.userData.knockedOver) {
                    npc.userData.knockOverTimer -= delta;
                    if (npc.userData.knockOverTimer > 2) {
                        npc.userData.spinAngle += delta * 2 * Math.PI;
                        npc.rotation.y = npc.userData.spinAngle;
                    }
                    if (npc.userData.knockOverTimer <= 0) {
                        npc.userData.knockedOver = false;
                        npc.rotation.x = 0;
                        npc.rotation.y = 0;
                        npc.position.y = terrain.geometry.attributes.position.array[Math.floor((npc.position.z / -2000) * 50) * (50 + 1) * 3 + 2] + 0.5;
                    }
                } else {
                    npc.position.z -= npc.userData.speed * delta;
                    const terrainHeight = terrain.geometry.attributes.position.array[Math.floor((npc.position.z / -2000) * 50) * (50 + 1) * 3 + 2] || 0;
                    npc.position.y = terrainHeight + 0.5;
                    if (npc.position.z < -1900) {
                        npc.position.z = 0;
                        npc.position.x = (Math.random() - 0.5) * 30;
                    }
                }
            });
        }

        function updateCollectables(delta) {
            collectables.forEach((collectable, index) => {
                const dist = skier.position.distanceTo(collectable.position);
                if (dist < 3) {
                    if (collectable.userData.type === 'speed') {
                        speedBoostTimer = 5;
                        showBonus('Speed Up!');
                    } else if (collectable.userData.type === 'life') {
                        lives++;
                        showBonus('+1 Life');
                    } else if (collectable.userData.type === 'snowball') {
                        snowballAmmo += 5;
                        showBonus('+5 Snowballs');
                    }
                    scene.remove(collectable);
                    collectables.splice(index, 1);
                } else {
                    collectable.userData.pulseTime += delta * 2;
                    const scale = collectable.userData.baseScale * (1 + 0.2 * Math.sin(collectable.userData.pulseTime));
                    collectable.scale.set(scale, scale, scale);
                }
            });
        }

        function updateBirds(delta) {
            birds.forEach((bird, index) => {
                if (bird.userData.hit) {
                    bird.userData.hitTimer -= delta;
                    bird.userData.spinAngle += delta * 2 * Math.PI;
                    bird.rotation.y = bird.userData.spinAngle;
                    bird.position.y -= delta * 10;
                    if (bird.userData.hitTimer <= 0) {
                        scene.remove(bird);
                        birds.splice(index, 1);
                    }
                } else {
                    bird.position.x = bird.userData.baseX + Math.sin(time * 0.5) * 10;
                    bird.position.z = bird.userData.baseZ + Math.cos(time * 0.3) * 10;
                    bird.children[1].rotation.x = Math.sin(time * 5) * 0.5;
                    bird.children[2].rotation.x = -Math.sin(time * 5) * 0.5;
                }
            });
        }

        function updateSnowflakes(delta) {
            snowflakes.forEach(snowflake => {
                snowflake.position.y -= snowflake.userData.speed * delta;
                if (snowflake.position.y < 0) {
                    snowflake.position.y = 20;
                    snowflake.position.x = skier.position.x + (Math.random() - 0.5) * 20;
                    snowflake.position.z = skier.position.z + (Math.random() - 0.5) * 20;
                }
            });
            frontSnowflakes.forEach(snowflake => {
                snowflake.position.y -= snowflake.userData.speed * delta;
                if (snowflake.position.y < 0) {
                    snowflake.position.y = 20;
                    snowflake.position.x = skier.position.x + (Math.random() - 0.5) * 20;
                    snowflake.position.z = skier.position.z - 10 + (Math.random() - 0.5) * 10;
                }
            });
        }

        function updateSnowballs(delta) {
            snowballs.forEach((snowball, index) => {
                snowball.position.add(snowball.userData.direction.clone().multiplyScalar(snowball.userData.speed * delta));
                if (snowball.position.z < -1900 || Math.abs(snowball.position.x) > 50 || snowball.position.y > 40) {
                    scene.remove(snowball);
                    snowballs.splice(index, 1);
                    return;
                }
                npcs.forEach(npc => {
                    if (npc.userData.knockedOver) return;
                    const dist = snowball.position.distanceTo(npc.position);
                    if (dist < 1) {
                        knockOverNPC(npc);
                        scene.remove(snowball);
                        snowballs.splice(index, 1);
                    }
                });
                birds.forEach(bird => {
                    if (bird.userData.hit) return;
                    const dist = snowball.position.distanceTo(bird.position);
                    if (dist < 0.5) {
                        hitBird(bird);
                        scene.remove(snowball);
                        snowballs.splice(index, 1);
                    }
                });
            });
        }

        function animate() {
            if (gameOver) return;
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            time += delta;
            snowballCooldown = Math.max(0, snowballCooldown - delta);
            if (autoPlay && skier && skidTimer <= 0) {
                let targetX = 0;
                let targetSpeed = -0.5;
                const nextFlag = flags.find(f => f.position.z > skier.position.z && Math.abs(f.position.z - skier.position.z) < 50);
                const nearestCollectable = collectables.reduce((nearest, c) => {
                    const dist = skier.position.distanceTo(c.position);
                    return dist < 20 && c.position.z > skier.position.z && (!nearest || dist < nearest.dist) ? { obj: c, dist } : nearest;
                }, null);
                if (nextFlag) {
                    const isBlue = nextFlag.material.color.getHex() === 0x0000FF;
                    targetX = nextFlag.position.x + (isBlue ? 2 : -2);
                } else if (nearestCollectable) {
                    targetX = nearestCollectable.obj.position.x;
                    targetSpeed = -0.7;
                }
                const dx = targetX - skier.position.x;
                joystick.x = Math.min(Math.max(dx * 0.05, -1), 1);
                joystick.y = targetSpeed;
                document.getElementById('knob').style.transform = `translate(${joystick.x * 25}px, ${joystick.y * 25}px)`;
            }
            if (skier) {
                if (autoThrow && snowballAmmo > 0 && snowballCooldown <= 0) {
                    let target = null;
                    let minDist = Infinity;
                    npcs.forEach(npc => {
                        if (isNPCTargetable(npc)) {
                            const dist = skier.position.distanceTo(npc.position);
                            if (dist < minDist) {
                                minDist = dist;
                                target = npc;
                            }
                        }
                    });
                    birds.forEach(bird => {
                        if (isBirdTargetable(bird)) {
                            const dist = skier.position.distanceTo(bird.position);
                            if (dist < minDist) {
                                minDist = dist;
                                target = bird;
                            }
                        }
                    });
                    if (target) {
                        fireSnowball();
                        snowballCooldown = 1;
                    }
                }
                if (skidTimer <= 0) {
                    const baseSpeed = 20;
                    currentSpeed = baseSpeed - joystick.y * 20 + (speedBoostTimer > 0 ? 10 : 0);
                    currentSpeed = Math.max(0, Math.min(50, currentSpeed));
                    speedBoostTimer = Math.max(0, speedBoostTimer - delta);
                    skier.position.x += joystick.x * 15 * delta;
                    skier.position.z -= currentSpeed * delta;
                    skier.position.x = Math.max(-15, Math.min(15, skier.position.x));
                }
                const terrainHeight = terrain && terrain.geometry.attributes.position.array[Math.floor((skier.position.z / -2000) * 50) * (50 + 1) * 3 + 2] || 0;
                skier.position.y = terrainHeight + 0.5;
                if (currentSpeed > 0 && time % 0.1 < delta && skidTimer <= 0) {
                    const leftParticle = createTrailParticle(skier.position.x - 0.3, skier.position.z, time);
                    const rightParticle = createTrailParticle(skier.position.x + 0.3, skier.position.z, time);
                    mainTrails.left.push(leftParticle);
                    mainTrails.right.push(rightParticle);
                    scene.add(leftParticle, rightParticle);
                }
                updateMainTrails();
                animateSkier(delta);
                updateNPCs(delta);
                updateCollectables(delta);
                updateBirds(delta);
                updateSnowballs(delta);
                updateSnowflakes(delta);
                updateScreenShake(delta);
                updateCamera(delta);
                flags.forEach((flag, index) => {
                    if (!flag) return;
                    const dist = skier.position.distanceTo(flag.position);
                    if (dist < 1) {
                        lives--;
                        knockOverFlag(flag);
                        showFlagHit();
                        stumbleTimer = 1.0;
                        flags.splice(index, 1);
                        setTimeout(() => scene.remove(flag), 1000);
                        lastFlagPassed = null;
                        if (lives <= 0) endGame();
                    } else if (dist < 2 && flag.position.z > skier.position.z) {
                        const isBlue = flag.material.color.getHex() === 0x0000FF;
                        const isCorrectSide = isBlue ? skier.position.x > flag.position.x : skier.position.x < flag.position.x;
                        if (isCorrectSide) {
                            score += 100;
                            showBonus('+100');
                            showMiniScore('+100', flag.position.x, flag.position.z, false);
                            showCorrectMessage(isBlue);
                        } else {
                            score = Math.max(0, score - 50);
                            showPenalty();
                            showMiniScore('-50', flag.position.x, flag.position.z, true);
                        }
                        flags.splice(index, 1);
                        scene.remove(flag);
                        lastFlagPassed = flag;
                    }
                });
                npcs.forEach(npc => {
                    if (npc.userData.knockedOver) return;
                    const dist = skier.position.distanceTo(npc.position);
                    if (dist < 1) {
                        showNPCHit();
                        stumbleTimer = 1.0;
                    }
                });
                const finishDistance = Math.abs(skier.position.z - (-1850));
                if (finishDistance <= 100 && skidTimer <= 0) {
                    showFinishMessage(finishDistance);
                } else {
                    hideFinishMessage();
                }
                if (skier.position.z < -1850 && skidTimer <= 0) {
                    skidTimer = 2;
                    joystick.x = 0;
                    joystick.y = 0;
                    document.getElementById('knob').style.transform = 'translate(0px, 0px)';
                }
                document.getElementById('stats').innerHTML = `
                    Level: ${level}<br>
                    Lives: ${lives}<br>
                    Score: ${score}<br>
                    Time: ${time.toFixed(1)}s<br>
                    Speed: ${currentSpeed.toFixed(1)} m/s<br>
                    Snowballs: ${snowballAmmo}
                `;
                updateMiniMap();
                updateProgressBar();
            }
            renderer.render(scene, camera);
        }

        function showBonus(text) {
            const bonusEl = document.getElementById('bonus');
            bonusEl.textContent = text;
            bonusEl.style.display = 'block';
            setTimeout(() => bonusEl.style.display = 'none', 1000);
        }

        function completeLevel() {
            gameOver = true;
            document.getElementById('levelComplete').style.display = 'block';
            document.getElementById('levelStats').innerHTML = `
                Level: ${level}<br>
                Score: ${score}<br>
                Time: ${time.toFixed(1)}s<br>
                Speed: ${currentSpeed.toFixed(1)} m/s
            `;
            document.getElementById('miniMap').style.display = 'none';
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('toggleCamera').style.display = 'none';
            document.getElementById('fireSnowball').style.display = 'none';
            document.getElementById('autoThrow').style.display = 'none';
            document.getElementById('toggleSnow').style.display = 'none';
        }

        function endGame() {
            gameOver = true;
            document.getElementById('gameOver').style.display = 'block';
            document.getElementById('finalStats').innerHTML = `
                Level: ${level}<br>
                Score: ${score}<br>
                Time: ${time.toFixed(1)}s<br>
                Speed: ${currentSpeed.toFixed(1)} m/s
            `;
            document.getElementById('miniMap').style.display = 'none';
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('toggleCamera').style.display = 'none';
            document.getElementById('fireSnowball').style.display = 'none';
            document.getElementById('autoThrow').style.display = 'none';
            document.getElementById('toggleSnow').style.display = 'none';
        }

        function nextLevel() {
            gameOver = false;
            level++;
            lives = 3;
            score = 0;
            time = 0;
            currentSpeed = 0;
            snowballAmmo = 0;
            speedBoostTimer = 0;
            autoPlay = false;
            autoThrow = true;
            snowballCooldown = 0;
            stumbleTimer = 0;
            skidTimer = 0;
            screenShake.active = false;
            lastFlagPassed = null;
            cameraMode = 'default';
            flyAroundAngle = 0;
            document.getElementById('toggleCamera').textContent = 'Camera: Default';
            document.getElementById('autoThrow').textContent = 'Auto-Throw: On';
            mainTrails.left.forEach(particle => scene.remove(particle));
            mainTrails.right.forEach(particle => scene.remove(particle));
            mainTrails = { left: [], right: [] };
            document.getElementById('autoPlay').textContent = 'Auto-Play: Off';
            snowflakes.forEach(snowflake => scene.remove(snowflake));
            frontSnowflakes.forEach(snowflake => scene.remove(snowflake));
            snowflakes = [];
            frontSnowflakes = [];
            snowActive = false;
            document.getElementById('toggleSnow').textContent = 'Snow: Off';
            scene.clear();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 20, 150);
            setupGame();
            document.getElementById('levelComplete').style.display = 'none';
            document.getElementById('miniMap').style.display = 'block';
            document.getElementById('progressBar').style.display = 'block';
            document.getElementById('stats').style.display = 'block';
            document.getElementById('toggleCamera').style.display = 'block';
            document.getElementById('fireSnowball').style.display = 'block';
            document.getElementById('autoThrow').style.display = 'block';
            document.getElementById('toggleSnow').style.display = 'block';
            resetJoystick();
            clock = new THREE.Clock();
            animate();
        }

        function restartGame() {
            gameOver = false;
            level = 1;
            lives = 3;
            score = 0;
            time = 0;
            currentSpeed = 0;
            snowballAmmo = 0;
            speedBoostTimer = 0;
            autoPlay = false;
            autoThrow = true;
            snowballCooldown = 0;
            stumbleTimer = 0;
            skidTimer = 0;
            screenShake.active = false;
            lastFlagPassed = null;
            cameraMode = 'default';
            flyAroundAngle = 0;
            document.getElementById('toggleCamera').textContent = 'Camera: Default';
            document.getElementById('autoThrow').textContent = 'Auto-Throw: On';
            mainTrails.left.forEach(particle => scene.remove(particle));
            mainTrails.right.forEach(particle => scene.remove(particle));
            mainTrails = { left: [], right: [] };
            document.getElementById('autoPlay').textContent = 'Auto-Play: Off';
            snowflakes.forEach(snowflake => scene.remove(snowflake));
            frontSnowflakes.forEach(snowflake => scene.remove(snowflake));
            snowflakes = [];
            frontSnowflakes = [];
            snowActive = false;
            document.getElementById('toggleSnow').textContent = 'Snow: Off';
            scene.clear();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 20, 150);
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('welcome').style.display = 'block';
            resetJoystick();
            clock = new THREE.Clock();
            animate();
        }

        init();
    </script>
</body>
</html>
